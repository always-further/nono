# Claude Code + Secretive + 1Password CLI
#
# For users who:
#   - Store SSH keys in macOS Secure Enclave via Secretive
#     (https://github.com/maxgoedjen/secretive) for git commit signing
#   - Use 1Password CLI (`op`) for secret retrieval with TouchID approval
#   - Use `gh` CLI authenticated through 1Password shell plugin
#
# Install:
#   mkdir -p ~/.config/nono/profiles
#   cp claude-code-with-secretive-1password.toml ~/.config/nono/profiles/
#
# Usage:
#   nono run --profile claude-code-with-secretive-1password --allow-cwd -- claude
#
# Go development on macOS:
#   The profile includes read access to $GOPATH/bin and read+write to the
#   module cache ($GOPATH/pkg/mod). This is sufficient for `go mod download`,
#   `go build`, and `go test` without granting access to all of $GOPATH.
#   If GOPATH is not ~/go, override with additional --read / --allow flags.
#
# Prerequisite:
#   Disable Claude Code's built-in sandbox so nono is the sole enforcer.

interactive = true

[meta]
name = "claude-code-with-secretive-1password"
version = "1.0.0"
description = "Claude Code with Secretive SSH agent and 1Password CLI (TouchID)"
author = "community"

[workdir]
access = "readwrite"

[filesystem]
allow = [
    # Claude Code state (debug logs, projects, settings)
    "$HOME/.claude",

    # git signing creates temp buffers in $TMPDIR (e.g. .git_signing_buffer_tmp*)
    "$TMPDIR",

    # Go module cache — `go mod download` and `go build` write here
    # (default GOMODCACHE = GOPATH/pkg/mod)
    "$HOME/go/pkg/mod",
]

read = [
    # Go toolchain — read-only access to compiled binaries (default GOPATH/bin)
    "$HOME/go/bin",

    # Secretive public keys — git reads these for commit signing verification
    "$HOME/Library/Containers/com.maxgoedjen.Secretive.SecretAgent/Data/PublicKeys",

    # 1Password CLI config (account settings, plugins)
    "$HOME/.config/op",

    # 1Password CLI state and daemon socket (~/.op/op-daemon.sock).
    # Required by `op plugin run` (used by gh CLI shell plugin).
    # `op read` can fall back to the app socket, but the plugin cannot.
    "$HOME/.op",

    # 1Password app data — required for `op` client initialization
    "$HOME/Library/Group Containers/2BUA8C4S2C.com.1password/Library/Application Support",

    # gh CLI config (settings, auth via 1Password shell plugin)
    "$HOME/.config/gh",
]

write = []

allow_file = [
    # Claude Code settings
    "$HOME/.claude.json",

    # SSH known_hosts — git/ssh may need to append new host keys
    "$HOME/.ssh/known_hosts",
]

read_file = [
    # macOS Keychain for Claude OAuth authentication
    "$HOME/Library/Keychains/login.keychain-db",

    # Git configuration (gpg.format = ssh, user.signingKey, etc.)
    "$HOME/.gitconfig",

    # SSH config (IdentityAgent pointing to Secretive socket)
    "$HOME/.ssh/config",

    # Secretive agent socket — a Unix domain socket, not a regular file.
    # Connecting uses (allow network-outbound) which nono grants by default.
    "$HOME/Library/Containers/com.maxgoedjen.Secretive.SecretAgent/Data/socket.ssh",

    # 1Password agent socket — `op` connects here to request secrets.
    # TouchID approval is handled by the 1Password desktop app on the
    # other side of this socket.
    "$HOME/Library/Group Containers/2BUA8C4S2C.com.1password/t/s.sock",

    # Global gitignore — git reads this during operations
    "$HOME/.gitignore",

    # allowed_signers for commit signature verification.
    # git may look in either location depending on gpg.ssh.allowedSignersFile config.
    "$HOME/.ssh/allowed_signers",
    "$HOME/.config/git/allowed_signers",
]

write_file = []

[network]
block = false

[secrets]

[hooks.claude-code]
event = "PostToolUseFailure"
matcher = "Read|Write|Edit|Bash"
script = "nono-hook.sh"
